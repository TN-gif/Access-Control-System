# RBAC 权限管理系统 - 问题排查与解决

本文件合并原《doc/数据库连接问题排查记录.md》《doc/问题解决总结.md》中的核心结论，提供数据库、登录与运行期常见问题的排查方法及工具指引。

## 1. 数据库连接问题排查

### 1.1 常见错误与现象

| 错误信息 | 可能原因 | 解决步骤 |
|----------|----------|----------|
| `Access denied for user 'root'@'localhost'` | 配置文件密码错误或 `root` 使用了 `caching_sha2_password` | 1) 确认 `resources/config.properties` 中 `db.password`；2) 在 MySQL 中执行 `ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '你的密码'; FLUSH PRIVILEGES;` |
| `Communications link failure` | MySQL 服务未启动、端口不一致 | 1) `net start MySQL80`；2) `SHOW VARIABLES LIKE 'port'` 确认端口；3) 更新 `db.url` |
| `Table 'rbac_system.users' doesn't exist` | 未执行初始化脚本 | `mysql -u root -p < sql/schema.sql` 然后 `mysql -u root -p < sql/init_data.sql` |
| `ClassNotFoundException: com.mysql.cj.jdbc.Driver` | 依赖缺失 | IDEA 右侧 Maven 面板点击 Reload，或在终端执行 `mvn dependency:resolve` |

### 1.2 X Protocol 与 JDBC 端口区分

- MySQL Shell 默认使用 `localhost:33060`（X Protocol），而 JDBC 连接使用 `3306`。
- 若 Shell 中无需密码即可登录，而 CLI 程序报 “using password: NO”，说明 `3306` 端口仍要求密码；请统一使用 `mysql_native_password` 并在 `config.properties` 中配置。

### 1.3 `TestConnection` 工具

运行 `mvn exec:java -Dexec.mainClass="com.rbac.test.TestConnection"` 可：
1. 打印当前加载的 `db.url/user/password length`;
2. 列出 `rbac_system` 下所有表；
3. 输出 `users` 表记录数；
4. 直接暴露配置/连接问题，建议在每次部署或密码修改后执行。


## 2. 登录问题与管理员密码修复

### 2.1 现象

- `admin/admin123` 登录失败，提示“用户名或密码错误”；
- 审计日志出现 `[AUDIT_FAIL] user=admin action=LOGIN msg=登录失败: 密码错误`。

### 2.2 根因

- `sql/init_data.sql` 使用了固定的测试盐值与哈希，无法直接验证真实密码；
- 未运行 `FixAdminPassword` 工具导致数据库中的密码与系统算法不匹配。

### 2.3 修复流程

1. **执行工具**
   ```bash
   mvn exec:java -Dexec.mainClass="com.rbac.test.FixAdminPassword"
   ```
   - 自动生成随机盐值；
   - 写入 admin 账户；
   - 验证 `admin123` 是否可通过。

2. **验证**
   - 运行 `MainApp` 登录；
   - 或使用 `com.rbac.test.DebugLogin` 查看数据库中的盐值/哈希、计算结果及状态（冻结/正常）。

3. **常见失误**
   - 只执行了 init SQL，但未运行修复工具；
   - 修改了数据库密码但未更新 `config.properties`；
   - `users` 表中 admin 被删除，可重新执行 init SQL 并再次运行 `FixAdminPassword`。

### 2.4 预防措施

- 在 `init_data.sql` 中保留醒目的警告注释；
- 在初始化/快速启动文档中强调“步骤四：修复管理员密码”；
- 在演示脚本准备阶段 checklist 中加入“已运行 FixAdminPassword”；
- 对外发布时可考虑将修复逻辑整合到初始化脚本或构建流程。


## 3. 运行期诊断工具

| 工具 | 适用场景 | 说明 |
|------|----------|------|
| `TestConnection` | 配置/网络排查 | 输出配置、表结构与连接结果 |
| `FixAdminPassword` | admin 密码修复 | 一键生成盐值+哈希并验证 |
| `GeneratePasswordHash` | 手动插入/替换管理员 | 生成 SQL 片段，可自定义密码 |
| `DebugLogin` | 登录失败定位 | 展示数据库哈希、盐值及 `verifyPassword` 结果 |
| `AuditAnalyzer` | 安全审计 | 按小时统计失败登录次数，识别暴力破解 |


## 4. 排障清单

1. **数据库准备**
   - [ ] `rbac_system` 数据库存在且包含 6 张主表
   - [ ] 已执行 schema/init SQL，若演示前需清理，可直接 `DROP DATABASE` → 重新导入
   - [ ] `root@localhost` 插件为 `mysql_native_password`

2. **配置文件**
   - [ ] `resources/config.properties` 中的密码已修改
   - [ ] `audit.log.path` 指向可写目录

3. **管理员账号**
   - [ ] 已运行 `FixAdminPassword`
   - [ ] 若登录仍失败，使用 `DebugLogin` 排查

4. **日志检查**
   - [ ] `logs/system.log` 中无持续性异常
   - [ ] `logs/audit.log` 存在最新记录

5. **常见故障处理**
   | 故障 | 操作 |
   |------|------|
   | CLI 启动后菜单异常 | 确保 `SessionContext` 未残留旧线程；如 IDE 仍在运行旧进程请先停止 |
   | 菜单提示与脚本不一致 | 以 `doc/02_部署运行与演示指南.md` 中的编号为准，并在演示时说明 |
   | 智能审计无输出 | 检查 `logs/audit.log` 是否存在最近的 `[AUDIT_FAIL] LOGIN`；确认阈值配置 |


## 5. 经验教训

- **文档与工具同等重要**：即便代码正确，若缺少“修复密码”提示，也会让使用者误以为系统有缺陷。
- **测试数据需显式声明**：在 SQL 脚本中标注“测试哈希”可避免误用。
- **自动化辅助排障**：`FixAdminPassword` 与 `DebugLogin` 显著提升了定位速度；后续可考虑将更多初始化逻辑脚本化。

---

若仍无法定位问题，可收集以下信息提交至研发团队：`config.properties`（隐藏真实密码）、`logs/system.log`、`logs/audit.log` 片段、操作步骤、`TestConnection` 输出以及数据库中 `users`/`user_roles` 数据快照。
