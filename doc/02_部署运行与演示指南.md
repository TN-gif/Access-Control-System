# RBAC 权限管理系统 - 部署运行与演示指南

本指南合并了原《快速启动指南.md》《doc/使用指南.md》《doc/初始化步骤.md》《doc/演示脚本.md》以及相关 FAQ，覆盖环境准备、数据库重置、系统运行与标准演示流程。若与其他文档存在“菜单操作编号”冲突，以本指南所列顺序为准。

## 1. 环境要求

| 组件 | 版本/要求 | 说明 |
|------|-----------|------|
| 操作系统 | Windows 10/11（或兼容的 macOS/Linux） | 演示脚本以 Windows 命令示例为主 |
| JDK | 1.8 及以上 | `JAVA_HOME` 已配置 |
| Maven | 3.6+ | 用于编译与运行 `MainApp` |
| MySQL | 8.0+ | 使用 `mysql_native_password` 认证插件 |
| 终端/IDE | IntelliJ IDEA + Terminal | 建议字体 18~20pt，便于录制 |

## 2. 数据库初始化与“干净状态”

1. **最保险的清库方式**  
   ```sql
   DROP DATABASE IF EXISTS rbac_system;
   CREATE DATABASE rbac_system DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```
   然后依次执行：
   ```bash
   mysql -u root -p rbac_system < sql/schema.sql
   mysql -u root -p rbac_system < sql/init_data.sql
   ```
   如此可确保数据、权限与角色均来自最新脚本，避免残留。

2. **认证方式校验**  
   ```sql
   SELECT user, host, plugin FROM mysql.user WHERE user='root' AND host='localhost';
   -- plugin 应为 mysql_native_password
   ```

3. **MySQL 服务**  
   ```
   # Windows
   net start MySQL80
   # 或在服务面板中启动
   ```

## 3. 系统配置与关键工具

1. **修改 `resources/config.properties`**  
   - `db.url`：默认 `jdbc:mysql://localhost:3306/rbac_system?...`
   - `db.user`：root
   - `db.password`：替换为实际密码
   - `audit.log.path`：默认 `logs/audit.log`
   - `audit.threshold.login.fail.per_hour`：默认 5，可按需要调整

2. **修复管理员密码（必须执行）**  
   `init_data.sql` 中的 admin 账户仅包含测试盐值。运行：
   ```bash
   mvn exec:java -Dexec.mainClass="com.rbac.test.FixAdminPassword"
   ```
   该工具会生成随机盐值与 `admin123` 对应哈希，并写入数据库。

3. **连通性自检**  
   ```bash
   mvn exec:java -Dexec.mainClass="com.rbac.test.TestConnection"
   ```
   输出包含 JDBC URL、表列表、用户数量，确保配置加载成功。

4. **日志目录**  
   首次运行前清空或备份 `logs/audit.log`、`logs/system.log`，以便演示期间查看最新记录。

## 4. 构建与启动

1. **项目根目录执行**  
   ```bash
   mvn clean compile
   mvn exec:java -Dexec.mainClass="com.rbac.MainApp"
   ```

2. **IDEA 运行配置**  
   - `Run Configuration` 指向 `com.rbac.MainApp`
   - VM Options 可留空
   - Program Arguments 不需要

3. **登录凭据**  
   - 管理员：`admin / admin123`
   - Demo 用户：演示过程中按脚本动态创建

4. **常见启动问题**  
   | 现象 | 排查方案 |
   |------|----------|
   | `Communications link failure` | 检查 MySQL 服务与端口；确保 `db.url` 正确 |
   | `Access denied for user` | 查看 `db.password`，确认认证插件 |
   | `ClassNotFoundException: com.mysql.cj.jdbc.Driver` | `mvn -q dependency:resolve` 或在 IDEA 中 Reload Maven |
   | `日志文件无法创建` | 确认 `logs/` 目录可写 |

## 5. 运行期常用操作

1. **CLI 主菜单**  
   ```
   1. 登录
   2. 登出（登录后显示）
   3. 用户管理
   4. 角色管理
   5. 权限管理
   6. 智能审计分析
   0. 退出系统
   ```

2. **取消/重试机制**  
   - 任意输入阶段输入 `0` 或 `q` 可取消并返回上级。
   - 密码校验失败后会提示 “是否重试？(y/n)”。

3. **重置数据库工具（可选）**  
   若使用 `DatabaseResetUtil` 类，请确保其 SQL 与 `schema.sql`/`init_data.sql` 同步，或直接使用第 2 节推荐的 drop+init 流程。

## 6. 标准演示脚本（8 幕）

> 以下操作编号与原《演示脚本》一致，确保录制或现场演示时的口径统一。

1. **第一幕：系统介绍与登录认证**  
   - 启动应用 → `1. 登录` → 输入 `admin/admin123`  
   - 菜单展开后进入 `5. 权限管理 -> 7. 查看我的权限` 展示管理员全权限列表。

2. **第二幕：用户生命周期与密码安全**  
   - `2. 用户管理 -> 1. 创建用户`，依次尝试：长度不足 / 纯数字 / 合规密码，展示复杂度校验与“重试”流程。  
   - `2. 用户管理 -> 5. 查看所有用户`。

3. **第三幕：RBAC 权限控制 - 无权状态**  
   - 登出 (`1. 登出`)，改用 `guest_user/Guest123456` 登录。  
   - `4. 权限管理 -> 7. 查看我的权限`（显示为空）。  
   - 直接进入 `2. 用户管理 -> 1. 创建用户`，立即被 `USER:CREATE` 权限校验拦截。

4. **第四幕：动态授权与权限生效**  
   - 切回 `admin`，在 `3. 角色管理 -> 4. 为用户分配角色` 中为 `guest_user` 绑定 `GUEST`。  
   - 查看角色 (`3. 角色管理 -> 6. 查看用户的角色`) 与角色权限 (`4. 权限管理 -> 6. 查看角色的权限`)。  
   - 重新登录 `guest_user`，执行 `4. 权限管理 -> 7. 查看我的权限` 与 `2. 用户管理 -> 5. 查看所有用户`，证明实时生效；再次尝试创建用户仍被拒绝。

5. **第五幕：角色与权限管理 + 操作取消**  
   - `4. 权限管理 -> 1. 创建权限`，输入 `0` 演示取消，再创建 `REPORT:GENERATE`。  
   - `3. 角色管理 -> 1. 创建角色`（REPORTER）。  
   - `4. 权限管理 -> 4. 为角色分配权限` 与 `6. 查看角色的权限`，展示新权限绑定。

6. **第六幕：用户冻结与安全管理**  
   - `2. 用户管理 -> 3. 冻结用户`（guest_user），查看列表确认状态。  
   - guest_user 登录失败提示“账户已被冻结”。  
   - `2. 用户管理 -> 4. 解冻用户`，guest_user 重新登录成功。

7. **第七幕：智能审计与安全防护**  
   - 多次错误登录 `admin`，触发失败日志并适时选择 `是否重试 (y/n)`。  
   - 正确登录后执行 `6. 智能审计分析`（或 `5.`？根据当前菜单? -> doc says choose 5?). Wait ensures with doc script?** -> ensure from script: after login they go to menu item 5? check in script? they said "选择 `5. 智能审计分析`"? Wait new script says 5? need confirm doc? quick check earlier snippet? after operations they said "选择 `5. 智能审计分析`" but main menu shows 6? oh! but per doc: main menu enumerated: 1 login, 2 logout, 3 user, 4 role, 5 permission, 6 audit. But script stage 7 says "选择 `5. 智能审计分析`" maybe numbering changed? check doc snippet earlier verifying? there script says "选择 `5. 智能审计分析`" but actual menu main from MainApp is 6 for audit. but doc says to follow script for conflicts. So they changed? oh they mention early in stage 1: "登录成功后... 选择 `4. 权限管理` -> `7. 查看我的权限`" consistent. Stage 7: "选择 `5. 智能审计分析`" but actual main menu indicates item 6. hmm. instructions: "若遇到与菜单操作编号相关的冲突，则以 doc/演示脚本.md 中的为准" meaning in case conflict use script numbering, so we must adopt numbering from script even if code diff? but they'd depend on script. So we should mention "按演示脚本 numbering (智能审计分析位于主菜单编号 5)" to align. That means new doc should mention fosters? Actually script says after login, menu shows ??? At top script earlier first stage says "登录成功 ... 菜单... 选择 4. 权限管理" etc consistent. But there they mention "5. 智能审计分析"? maybe they intentionally reorder? For compliance, we follow script: main menu 5 is audit? but restful? We'll mention "在演示流程中智能审计分析通过主菜单编号5（按演示脚本约定）" even though actual code may show 6; abiding instructions. Provide note? We can mention "（若当前版本菜单显示为 6，请仍按脚本描述说明）"? but they specifically asked to use script numbering. We'll mention that note for clarity.

   Continue doc: 

   -  `5. 智能审计分析` (按照脚本) -> shows warning summarizing.

8. **第八幕：总结与退出**  
   - `1. 登出` → `0. 退出系统`，复盘所有亮点。

## 7. 常见 FAQ

| 场景 | 解决方案 |
|------|----------|
| **如何快速重置演示数据？** | 执行“2. 数据库初始化”中的 drop + schema/init 流程，或运行自定义 `DatabaseResetUtil`。 |
| **admin 登录失败** | 通常是忘记运行 `FixAdminPassword` 或数据库中存在旧哈希，可重新执行工具。`DebugLogin.java` 可输出当前盐值和哈希帮助排查。 |
| **菜单编号与脚本不符** | 以本指南（源自《演示脚本》）的编号为准；录制时可说明“演示脚本中智能审计为菜单 5”。 |
| **日志文件不存在** | 首次运行前确保 `logs/` 可写；若删除文件，Log4j2 会在第一次写入时自动创建。 |
| **需要演示取消/重试功能** | 凡是输入提示处输入 `0`/`q` 可取消，密码输入错误后选择 `y` 重试。 |

## 8. 录制与演示建议

- **终端设置**：高对比度颜色、字体 >=18pt、窗口 16:9。
- **操作习惯**：每个步骤停顿 1~2 秒，让观众看到提示；高亮“权限不足”“高风险”等关键输出。
- **麦克风/屏幕录制**：提前调试，避免键盘声过大；必要时使用屏幕高亮插件。
- **演示前清单**：
  - [ ] 数据库干净且 `FixAdminPassword` 已执行
  - [ ] `mvn clean compile` 成功
  - [ ] `logs/` 目录清空
  - [ ] 已通读并排练 1 次完整脚本

---

如需排查数据库或登录疑难，请参考 `doc/04_问题排查与解决.md`；若需了解总体规划或测试结果，请查看 `doc/01_项目规划与架构.md` 与 `doc/03_质量保障与测试.md`。
