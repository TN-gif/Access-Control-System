# RBAC 权限管理系统 - 质量保障与测试

本文整合原《doc/测试用例.md》与《代码检查报告.md》内容，概述测试环境、覆盖范围、重点用例、审计验证与静态检查结果。

## 1. 测试环境

| 项目 | 配置 |
|------|------|
| 操作系统 | Windows 10/11 |
| JDK | 1.8+ |
| 数据库 | MySQL 8.0 |
| 构建工具 | Maven 3.6+ |
| 日志 | Log4j2（系统日志 + 审计日志分开 Rolling） |
| 测试日期 | 2024-11-18 |


## 2. 测试策略

1. **功能回归**：围绕主菜单的用户、角色、权限、智能审计模块执行完整手工用例。
2. **安全与权限**：验证 RBAC 拦截、密码复杂度、冻结状态、审计日志完整性。
3. **异常处理**：模拟数据库断连、重复输入、菜单取消、非法 ID/字符串输入等。
4. **质量检查**：通过人工静态检查确认资源释放、异常处理、日志与编码规范。
5. **工具联动**：使用 `TestConnection`、`FixAdminPassword`、`DebugLogin`、`GeneratePasswordHash` 对部署与诊断流程进行验证。


## 3. 重点功能用例摘要

### 3.1 登录模块
- 正常登录：`admin/admin123` 成功并写入 `[AUDIT_SUCCESS] LOGIN`。
- 错误用户名 / 错误密码：提示“用户名或密码错误”，审计记录 `[AUDIT_FAIL]`。
- 冻结账户登录：输出“账户已被冻结”，审计日志注明原因。

### 3.2 用户管理
- 创建用户：验证用户名唯一性、密码长度与“字母+数字”规则；成功后 `userService` 与 `AuditLogger` 均有记录。
- 删除/冻结/解冻：操作前列出用户 ID，操作后再次列表确认状态变化，并校验对应 `[AUDIT_CRITICAL]` 日志。
- 查看用户列表：确保表格展示 ID、用户名、状态、创建时间并支持无权限被拦截。

### 3.3 角色管理
- 创建/删除角色：验证角色编码唯一，日志记录 `CREATE_ROLE` / `DELETE_ROLE`。
- 为用户分配/移除角色：校验 `user_roles` 表变更及实时权限生效；对未拥有的角色移除操作给出友好提示。
- 查看用户角色：显示 ID、编码、名称、描述；权限不足时即时拦截。

### 3.4 权限管理
- 创建/删除权限：测试取消（输入 `0`/`q`）与成功路径；日志包含 `CREATE_PERMISSION`、`DELETE_PERMISSION`。
- 角色授权/撤销：验证 `role_permissions` 表更新及 `AuthPermissionServiceDecorator` 日志；注意若缺少 `PERMISSION:REVOKE` 权限将提示权限不足——此为现存数据配置差异，已在报告中说明。
- 查看角色权限 / 查看我的权限：确保编码+描述同时显示。

### 3.5 智能审计分析
- 模拟 5 次错误登录 → 再运行“智能审计分析”（演示脚本将其列为主菜单编号 5）；`AuditAnalyzer` 应在同一小时的聚合结果中输出高风险警告。
- 删除或不可读日志：系统提示“审计日志文件不存在”或“读取失败”，验证异常分支。

### 3.6 异常与容错
- 数据库断连：停止 MySQL 再运行 CLI，确认报错信息友好且系统未崩溃。
- 输入非法 ID 或空字符串：CLI 捕获 `NumberFormatException` 并提示“无效的 ID/输入”。
- 登录重试/取消：错误密码后走 `是否重试？(y/n)` 分支，验证用户体验。


## 4. 审计与日志核查

- **格式**：`yyyy-MM-dd'T'HH:mm:ss [AUDIT_*] user=xx action=xx target=xx msg=xx result=xx`。
- **覆盖范围**：
  - 登录成功/失败、登出
  - 权限检查失败
  - 用户/角色/权限的创建、删除、冻结、授权等敏感操作
- **日志位置**：`logs/audit.log`（按日期+大小滚动），`logs/system.log` 存放常规输出和异常堆栈。
- **Analyzer**：读取审计日志、按用户+小时统计 `LOGIN` 失败次数，超过 `audit.threshold.login.fail.per_hour` (默认 5) 即输出告警。


## 5. 质量与代码检查结果

| 检查项 | 结果 | 说明 |
|--------|------|------|
| 资源管理 | ✅ | 所有 DAO 在 finally 中调用 `DBUtil.closeAll(...)`，`DBUtil` 也提供单独 close 方法 |
| SQL 注入防护 | ✅ | 全部使用 PreparedStatement，未发现字符串拼接 SQL |
| 异常处理 | ✅ | Service 抛业务异常，CLI 统一捕获并展示友好消息，主程序顶层兜底 |
| 空值/线程安全 | ✅ | 登录前检查空值，`SessionContext` 使用 ThreadLocal 并在登出时 clear |
| 密码安全 | ✅ | SHA-256 + Base64 盐值；`FixAdminPassword`/`GeneratePasswordHash` 工具辅助 |
| 审计日志 | ✅ | 装饰器与 `AuthService` 覆盖所有敏感路径，`AUDIT_SUCCESS/FAIL/CRITICAL` 标记清晰 |
| 代码规范 | ✅ | 驼峰命名、包名小写、常量大写、核心类具备注释；共有 ~31 个 Java 类 |
| 改进建议 | ⭐ | 可用日志替代 `printStackTrace`，引入连接池/事务（低优先级、非必需） |


## 6. 工具与支撑脚本

| 工具类 | 作用 |
|--------|------|
| `TestConnection.java` | 打印 JDBC 配置、列出数据表、确认连接可用 |
| `FixAdminPassword.java` | 自动生成随机盐值 + `admin123` 哈希并更新数据库 |
| `GeneratePasswordHash.java` | 生成 SQL 片段，供手动插入新管理员或重置密码 |
| `DebugLogin.java` | 输出数据库中盐值、哈希与计算结果，定位登录问题 |


## 7. 结论

- 所有功能用例均通过，覆盖登录、RBAC 权限、动态授权、冻结/解冻、智能审计等关键路径。
- 审计日志完整，`AuditAnalyzer` 能准确识别登录失败的高风险行为。
- 静态检查未发现严重缺陷，改进建议仅涉及日志输出、连接池/事务等可选优化。
- 系统具备完整测试与工具链支撑，可在“干净数据库”环境下快速复现。

如需更详细的部署或排障说明，请参考 `doc/02_部署运行与演示指南.md` 与 `doc/04_问题排查与解决.md`。
