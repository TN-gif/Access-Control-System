# RBAC 权限管理系统 - 项目规划与架构

本文件整合原 `README.md`、`doc/实验方案.txt`、`doc/架构规划.md` 与 `doc/todoList.md` 等资料，提供项目背景、需求、架构与实施进度的统一视图。

## 1. 项目背景与目标

- **项目类型**：Java SE 命令行程序，聚焦 RBAC（Role-Based Access Control）模型，实现用户、角色、权限三层映射与智能审计。
- **实验目的**：掌握 Java 面向对象特性、JDBC、日志审计与命令行交互实践，并探索基于规则的安全分析。
- **业务目标**：
  1. 支撑完整的用户/角色/权限生命周期管理；
  2. 在命令行中提供清晰的主/子菜单，确保输入校验与友好提示；
  3. 记录关键操作日志并进行登录暴力破解分析；
  4. 通过装饰器模式在 Service 边界统一植入 RBAC 权限校验与审计。

## 2. 需求概览

### 2.1 功能需求

| 模块 | 关键能力 |
|------|-----------|
| 用户管理 | 创建/删除用户、查看列表、登录登出、冻结/解冻 |
| 角色管理 | 创建/删除角色、查看角色、为用户分配/移除角色 |
| 权限管理 | 定义权限点、为角色授权/解除授权、查看角色权限、查看“我的权限” |
| 权限校验 | 登录后对敏感操作做 RBAC 校验，权限不足即时拦截 |
| 审计日志 | 登录成功/失败、权限变化、敏感操作的结构化记录 |
| 智能审计 | 在 1 小时窗口中统计失败登录次数，超阈值触发告警 |

### 2.2 非功能需求

- **结构清晰**：CLI ↔ Service ↔ 装饰器 ↔ DAO ↔ 数据库，层次分明。
- **安全性**：密码采用 SHA-256 + 随机盐值，所有敏感操作需具备相应权限并记录审计。
- **可维护性**：使用接口 + 实现 + 装饰器的组合，便于扩展；自定义异常统一反馈。
- **可扩展性**：权限点、审计规则可通过配置/代码扩展；DAO/Service 接口预留扩展。

## 3. 技术栈与设计模式

- **语言/运行环境**：Java SE 8+
- **数据库**：MySQL 8.0，JDBC 直连
- **日志**：Log4j2，独立的系统日志与审计日志 RollingFile
- **构建工具**：Maven 3.6+，`pom.xml` 指定 `mysql-connector-java 8.0.33` 与 Log4j2 依赖
- **核心模式**：
  - DAO 模式：封装数据库访问（`UserDao`、`RoleDao`、`PermissionDao` 等）
  - 装饰器模式：`Auth*ServiceDecorator` 在业务方法外层添加权限校验与审计记录
  - 工具/单例模式：`ConfigUtil`、`DBUtil`、`PasswordUtil`、`SessionContext`
  - 规则分析：`AuditAnalyzer` 使用 Stream API 对日志做分组统计

## 4. 系统架构

```
CLI(MainApp/MenuHandler)
        ↓
Service 接口(User/Role/Permission/Auth)
        ↓ (装饰器包装权限校验+审计)
Auth*ServiceDecorator
        ↓
DAO 层(UserDao/RoleDao/PermissionDao/UserRoleDao/RolePermissionDao)
        ↓
MySQL（users / roles / permissions / user_roles / role_permissions / audit_logs）
```

- **CLI 层**：负责主循环、菜单展示、输入校验与友好提示。
- **Service 层**：封装业务验证与组合操作，只处理业务语义。
- **装饰器层**：`AuthUserServiceDecorator`、`AuthRoleServiceDecorator`、`AuthPermissionServiceDecorator` 在 Service 调用前统一执行 `AuthService.checkPermission()` 并调用 `AuditLogger`。
- **DAO 层**：所有 SQL 使用 PreparedStatement，避免 SQL 注入并集中管理数据访问。
- **工具模块**：`ConfigUtil` 读取 `resources/config.properties`，`DBUtil` 管理连接，`SessionContext` 用 ThreadLocal 存储当前用户，`PasswordUtil` 提供哈希与校验，`AuditLogger` 统一日志格式。
- **审计/分析模块**：`audit/log4j2.xml` 定义 `AUDIT` Logger，`AuditAnalyzer` 从 `logs/audit.log` 读取数据并按小时统计失败登录次数。

## 5. 数据模型与权限体系

- **核心表**：
  - `users`：存储用户名、盐值、密码哈希、状态。
  - `roles`：存储角色编码/名称/描述。
  - `permissions`：存储权限编码与描述。
  - `user_roles`：多对多映射，维护用户拥有哪些角色。
  - `role_permissions`：多对多映射，维护角色拥有哪些权限。
  - `audit_logs`：预留表结构，如需数据库级别审计可扩展。
- **预置角色**：`ADMIN`、`USER_MANAGER`、`AUDITOR`、`GUEST`。
- **预置权限**：`USER:*`、`ROLE:*`、`PERMISSION:*`、`AUDIT:VIEW`、`AUDIT:ANALYZE` 等 17 个编码，可通过 SQL 初始化脚本拓展。

## 6. 实施进度（来自 todoList）

| 阶段 | 状态 | 说明 |
|------|------|------|
| 环境/基础设施 | ✅ 完成 | 配置文件、DB Schema、日志框架就绪 |
| 领域模型与 DAO | ✅ 完成 | 用户/角色/权限实体与 DAO CRUD 完成 |
| Service 层 | ✅ 完成 | 业务接口、实现与异常体系落地 |
| 权限装饰器与审计 | ✅ 完成 | 装饰器植入权限校验，审计日志全覆盖 |
| CLI 交互 | ✅ 完成 | 主/子菜单、输入合法性与统一提示实现 |
| 智能审计分析 | ✅ 完成 | `AuditAnalyzer` 支持失败登录统计预警 |
| 验证与交付 | ✅ 完成 | 手工用例验证 + 交付文档整理 |

---

> 如需了解部署、测试或排障细节，请参阅 `doc/02_部署运行与演示指南.md`、`doc/03_质量保障与测试.md` 与 `doc/04_问题排查与解决.md`。全部新文档位于 `doc/` 目录，替代原分散资料。
